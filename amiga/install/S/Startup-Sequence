; Startup Sequence for HstWB Installer
; ------------------------------------
;
; Date: 2018-03-29
; Author: Henrik Noerfjand Stengaard


; Load patched scsi.device v43.45, if it exists
IF EXISTS DEVS:scsi.device
  ; Load scsi.device, if current loaded scsi.device is less than v43.45
  Version >NIL: "scsi.device" 43 45
  IF WARN
    LoadModule DEVS:scsi.device
  ENDIF
ENDIF


; Add alias
Alias cls "Echo NOLINE *"*E[0;0H*E[J*" " 


; Startup message
cls 
echo "*e[32m" NOLINE
echo "HstWB Installer"
echo "*e[0m*e[1m" NOLINE
echo "---------------"
echo "*e[0m" NOLINE
echo ""
echo "HstWB Installer is now running install."

; Set stack
stack 16384

; Set failat to 255 for DiskInDrive to fail silently
failat 255

set amigaos39 "1"

; Goto load system files, if CD0: is not present
DiskInDrive >NIL: CD0:
IF WARN
  ; Set failat to 21
  failat 21
  set amigaos39 "0"
  SKIP loadsystemfiles
ENDIF

; Goto load system files, if AmigaOS3.9: is not present
DiskInDrive >NIL: AmigaOS3.9:
IF WARN
  ; Set failat to 21
  failat 21
  set amigaos39 "0"
  SKIP loadsystemfiles
ENDIF

; Set failat to 21
failat 21

; Goto load system files, if AmigaOS3.9:EMERGENCY-BOOT doesn't exist
IF NOT EXISTS AmigaOS3.9:EMERGENCY-BOOT
  set amigaos39 "0"
ENDIF


; Load system files
; -----------------
LAB loadsystemfiles

; Load basic commands resident
echo ""
IF "$amigaos39" EQ 1 VAL
  echo "*e[1mLoading Workbench system files from Amiga OS 3.9 cd-rom...*e[0m"
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Assign" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Copy" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Delete" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Eval" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Execute" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Rename" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/MakeDir" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Protect" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Search" PURE 
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Wait" PURE 
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Which" PURE 
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Mount" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Type" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/RequestChoice" PURE
  resident "AmigaOS3.9:EMERGENCY-BOOT/C/Version" PURE
ELSE
  echo "*e[1mLoading Workbench system files from Workbench 3.1 disk...*e[0m"
  "DF0:C/AddBuffers" >NIL: DF0: 200
  resident "DF0:C/Assign" PURE
  resident "DF0:C/Copy" PURE
  resident "DF0:C/Delete" PURE
  resident "DF0:C/Eval" PURE
  resident "DF0:C/Execute" PURE
  resident "DF0:C/Rename" PURE
  resident "DF0:C/MakeDir" PURE
  resident "DF0:C/Protect" PURE
  resident "DF0:C/Search" PURE 
  resident "DF0:C/Wait" PURE 
  resident "DF0:C/Which" PURE 
  resident "DF0:C/Mount" PURE
  resident "DF0:C/Type" PURE
  resident "DF0:C/RequestChoice" PURE
  resident "DF0:C/Version" PURE
ENDIF
echo "Done"

MakeDir RAM:Clipboards RAM:ENV RAM:ENV/Sys
Assign ENV: RAM:Env
Assign T: RAM:
SetEnv TZ MST7

wait 3


; Fail, if assign hstwb installer doesn't exist
IF NOT EXISTS S:Assign-HstWB-Installer
  echo "" >INSTALLDIR:Error
  echo "Error: assign hstwb installer doesn't exist!"
  SKIP fail
ENDIF
execute S:Assign-HstWB-Installer


; Install HstWB Installer Packages prefs
IF EXISTS INSTALLDIR:Prefs/Packages/Packages.ini
  MakePath >NIL: SYSTEMDIR:Prefs/HstWB-Installer/Packages
  copy >NIL: INSTALLDIR:Prefs/Packages/Packages.ini SYSTEMDIR:Prefs/HstWB-Installer/Packages/Packages.ini
ENDIF


; Install HstWB Installer Assigns prefs
IF EXISTS INSTALLDIR:Prefs/Packages/Assigns.ini
  MakePath >NIL: SYSTEMDIR:Prefs/HstWB-Installer/Packages
  copy >NIL: INSTALLDIR:Prefs/Packages/Assigns.ini SYSTEMDIR:Prefs/HstWB-Installer/Packages/Assigns.ini
ENDIF


; Run prepare install
execute "INSTALLDIR:S/Prepare-Install"


; Run install start
execute "INSTALLDIR:S/Install-Start"


; Run install complete
execute "INSTALLDIR:S/Install-Complete"

SKIP end


; Fail
LAB fail
echo ""
echo "Installation failed."
quit


; End
LAB end